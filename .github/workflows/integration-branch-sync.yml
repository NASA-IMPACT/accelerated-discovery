name: Integration Branch Sync
on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [develop]

jobs:
  test-pr-branch:
    name: Run Tests on PR Branch üß™
    runs-on: ubuntu-latest
    environment: integration
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          lfs: "true"
          submodules: "recursive"

      - name: Set up python
        uses: actions/setup-python@v4
        with:
          python-version: "3.12"
          cache: "pip"

      - name: Install requirements
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
        working-directory: ${{ vars.CDK_WORKING_DIRECTORY }}

      - name: Run tests with coverage
        id: test
        env:
          PYTHONUNBUFFERED: 1
          FORCE_COLOR: 1
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          SEARXNG_BASE_URL: ${{ vars.SEARXNG_BASE_URL}}
        run: |
          echo "Checking environment setup..."
          if [ -z "$OPENAI_API_KEY" ]; then
            echo "‚ùå OPENAI_API_KEY is not set"
          else
            echo "‚úÖ OPENAI_API_KEY is set (length: ${#OPENAI_API_KEY})"
            echo "Key starts with: ${OPENAI_API_KEY:0:7}..." # Show first 7 chars safely
          fi

          echo "Running tests..."
          echo "Using SearxNG instance: $SEARXNG_BASE_URL"
          set +e  # Don't exit on command failure

          # Capture test output for parsing
          python -m pytest tests/ -v --cov --cov-report=xml --cov-report=term > test_output.log 2>&1
          test_exit_code=$?

          # Display the output
          cat test_output.log

          echo ""
          echo "üìä Test Results Summary:"
          echo "Exit code: $test_exit_code"

          # Extract test results from pytest output
          if [ -f test_output.log ]; then
            # Extract passed/failed counts from pytest summary
            failed_count=$(grep -E "= [0-9]+ failed" test_output.log | sed -E 's/.*= ([0-9]+) failed.*/\1/' || echo "0")
            passed_count=$(grep -E "[0-9]+ passed" test_output.log | sed -E 's/.*([0-9]+) passed.*/\1/' || echo "0")

            # Extract coverage percentage from coverage report
            coverage_percent=$(grep -E "TOTAL.*[0-9]+%" test_output.log | awk '{print $(NF)}' | sed 's/%//' || echo "0")

            echo "Extracted metrics:"
            echo "- Passed tests: $passed_count"
            echo "- Failed tests: $failed_count"
            echo "- Coverage: $coverage_percent%"

            # Set outputs for GitHub Actions
            echo "passed_tests=$passed_count" >> $GITHUB_OUTPUT
            echo "failed_tests=$failed_count" >> $GITHUB_OUTPUT
            echo "coverage_percent=$coverage_percent" >> $GITHUB_OUTPUT
          fi

          # Check for coverage files
          if [ -f coverage.xml ]; then
            echo "‚úÖ Coverage XML generated"
          fi

          if [ -f htmlcov/index.html ]; then
            echo "‚úÖ HTML coverage report generated"
          fi

          # Set output for later use
          if [ $test_exit_code -eq 0 ]; then
            echo "test_result=success" >> $GITHUB_OUTPUT
          else
            echo "test_result=failure" >> $GITHUB_OUTPUT
          fi

          echo "test_exit_code=$test_exit_code" >> $GITHUB_OUTPUT

          # Always exit successfully to show coverage table
          exit 0
        working-directory: ${{ vars.CDK_WORKING_DIRECTORY }}

      - name: Upload coverage reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: pr-branch-coverage-report
          path: ${{ vars.CDK_WORKING_DIRECTORY }}/coverage.xml

      - name: Comment PR with test results
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const testResult = '${{ steps.test.outputs.test_result }}';
            const exitCode = '${{ steps.test.outputs.test_exit_code }}';
            const passedTests = '${{ steps.test.outputs.passed_tests }}' || '0';
            const failedTests = '${{ steps.test.outputs.failed_tests }}' || '0';
            const coveragePercent = '${{ steps.test.outputs.coverage_percent }}' || '0';

            const outcome = testResult === 'success' ? '‚úÖ Tests passed' : `‚ùå Tests failed (exit code: ${exitCode})`;

            let testSummary = '';
            if (passedTests !== '0' || failedTests !== '0') {
              testSummary = `\n\n## üìä Test Results\n- **Passed**: ${passedTests}\n- **Failed**: ${failedTests}\n- **Coverage**: ${coveragePercent}%`;
            }

            github.rest.issues.createComment({
              issue_number: ${{ github.event.pull_request.number }},
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `${outcome}${testSummary}\n\nBranch: \`${{ github.head_ref }}\`\nPR: #${{ github.event.pull_request.number }}\nCommit: ${{ github.sha }}\n\nüìã Full coverage report and logs are available in the [workflow run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}).`
            })

  sync-integration:
    name: Sync Integration Branch
    needs: [test-pr-branch]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout integration branch
        uses: actions/checkout@v4
        with:
          ref: integration
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Merge PR branch into integration
        run: |
          git fetch origin ${{ github.head_ref }}
          git merge origin/${{ github.head_ref }} --no-ff -m "Auto-merge PR #${{ github.event.pull_request.number }} (${{ github.head_ref }}) into integration for testing"

      - name: Push integration branch
        run: git push origin integration

      - name: Create issue on merge conflict
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'Integration branch merge conflict',
              body: `Automatic merge of PR #${{ github.event.pull_request.number }} (${{ github.head_ref }}) into integration failed.\n\nPlease resolve conflicts manually:\n\`\`\`bash\ngit checkout integration\ngit merge origin/${{ github.head_ref }}\n# resolve conflicts\ngit push origin integration\n\`\`\``,
              labels: ['integration', 'conflict']
            })
